From 29e1719478d0c0992168e0d45002d5d4a81cfc9b Mon Sep 17 00:00:00 2001
From: Yegor Yefremov <yegorslists@googlemail.com>
Date: Mon, 2 May 2016 10:15:55 +0200
Subject: [PATCH] am335x-baltos: enable mPCIe slot by default

Signed-off-by: Yegor Yefremov <yegorslists@googlemail.com>
---
 board/vscom/baltos/board.c | 9 +++++++++
 board/vscom/baltos/mux.c   | 6 ++++++
 2 files changed, 15 insertions(+)

diff --git a/board/vscom/baltos/board.c b/board/vscom/baltos/board.c
index 27056e1..15325af 100644
--- a/board/vscom/baltos/board.c
+++ b/board/vscom/baltos/board.c
@@ -39,6 +39,7 @@ DECLARE_GLOBAL_DATA_PTR;
 /* GPIO that controls power to DDR on EVM-SK */
 #define GPIO_DDR_VTT_EN		7
 #define DIP_S1			44
+#define MPCIE_SW		100
 
 static struct ctrl_dev *cdev = (struct ctrl_dev *)CTRL_DEVICE_BASE;
 
@@ -355,6 +356,14 @@ int board_late_init(void)
 			baltos_set_console();
 		}
 	}
+
+	if (gpio_request(MPCIE_SW, "mpcie_sw")) {
+		printf("failed to export GPIO %d\n", MPCIE_SW);
+	}
+	if (gpio_direction_output(MPCIE_SW, 1)) {
+		printf("failed to set GPIO %d direction\n", MPCIE_SW);
+	}
+
 	setenv("board_name", model);
 #endif
 
diff --git a/board/vscom/baltos/mux.c b/board/vscom/baltos/mux.c
index 8783b25..d1d02d6 100644
--- a/board/vscom/baltos/mux.c
+++ b/board/vscom/baltos/mux.c
@@ -139,6 +139,11 @@ static struct module_pin_mux nand_pin_mux[] = {
 	{-1},
 };
 
+static struct module_pin_mux pcie_sw_pin_mux[] = {
+	{OFFSET(mii1_rxdv), (MODE(7) | PULLUDEN )},     /* GPIO3_4 */
+	{-1},
+};
+
 void enable_uart0_pin_mux(void)
 {
 	configure_module_pin_mux(uart0_pin_mux);
@@ -187,6 +192,7 @@ void enable_board_pin_mux()
 	configure_module_pin_mux(rgmii2_pin_mux);
 	configure_module_pin_mux(rmii1_pin_mux);
 	configure_module_pin_mux(mmc0_pin_mux);
+	configure_module_pin_mux(pcie_sw_pin_mux);
 
 #if defined(CONFIG_NAND)
 	configure_module_pin_mux(nand_pin_mux);
-- 
2.1.4

